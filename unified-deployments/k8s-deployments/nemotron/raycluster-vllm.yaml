# RayCluster for Distributed vLLM with Pipeline Parallelism
#
# Uses KubeRay operator to manage Ray cluster lifecycle.
# Supports multiple LLM models across 2 DGX Spark nodes using pipeline parallelism.
#
# Architecture:
#   - Head node (spark-2959): Ray head + 1 GPU worker
#   - Worker node (spark-ba63): Ray worker + 1 GPU
#   - Pipeline Parallelism: 2 (splits model layers across nodes)
#   - Communication: 200GbE fabric network (10.10.10.x)
#
# Model Caching:
#   - Models cached at /var/lib/vllm-models on each node (hostPath)
#   - Cache persists across pod restarts - no re-downloading!
#   - First download goes to head, then sync to worker:
#       ./manage-cache.sh preload nvidia/NVIDIA-Nemotron-3-Nano-30B-A3B-BF16
#       ./manage-cache.sh sync
#   - Check cache: ./manage-cache.sh status
#
# After cluster is ready, run:
#   kubectl exec -n llm-inference <head-pod> -- vllm serve ...
#
apiVersion: ray.io/v1
kind: RayCluster
metadata:
  name: vllm-cluster
  namespace: llm-inference
  labels:
    app.kubernetes.io/name: vllm-distributed
    app.kubernetes.io/component: ray-cluster
spec:
  rayVersion: '2.40.0'
  enableInTreeAutoscaling: false
  
  # Head node configuration
  headGroupSpec:
    rayStartParams:
      dashboard-host: '0.0.0.0'
      num-gpus: '1'
      # Use fabric network for Ray communication
      node-ip-address: '10.10.10.1'
    
    template:
      metadata:
        labels:
          app: vllm-ray-head
          ray-cluster: vllm-cluster
          ray-node-type: head
      spec:
        runtimeClassName: nvidia
        
        # Pin head to spark-2959
        nodeSelector:
          kubernetes.io/hostname: spark-2959
        
        tolerations:
          - key: nvidia.com/gpu
            operator: Exists
            effect: NoSchedule
        
        # Use host network for fabric access
        hostNetwork: true
        dnsPolicy: ClusterFirstWithHostNet
        
        containers:
          - name: ray-head
            image: avarok/vllm-dgx-spark:v11
            imagePullPolicy: IfNotPresent
            
            ports:
              - containerPort: 6379
                name: gcs
              - containerPort: 8265
                name: dashboard
              - containerPort: 10001
                name: client
            
            env:
              - name: HF_TOKEN
                valueFrom:
                  secretKeyRef:
                    name: hf-token-secret
                    key: HF_TOKEN
              - name: HF_HOME
                value: /models/.cache
              - name: TRANSFORMERS_CACHE
                value: /models/.cache
              - name: HF_HUB_CACHE
                value: /models/.cache/hub
              - name: VLLM_HOST_IP
                value: "10.10.10.1"
              # Ray address for vLLM to connect to
              - name: RAY_ADDRESS
                value: "10.10.10.1:6379"
              # Disable CUDA graphs for Blackwell stability
              - name: VLLM_USE_CUDA_GRAPH
                value: "0"
              # NCCL configuration for fabric network (10.10.10.x)
              # Use explicit interfaces for head node (enP7s7) and worker node (enp1s0f1np1)
              - name: NCCL_SOCKET_IFNAME
                value: "enP7s7,enp1s0f1np1"
              - name: NCCL_IB_DISABLE
                value: "1"
              - name: NCCL_DEBUG
                value: "INFO"
              - name: NCCL_P2P_DISABLE
                value: "1"
              - name: GLOO_SOCKET_IFNAME
                value: "enP7s7,enp1s0f1np1"
              # Force NCCL to use TCP/socket communication
              - name: NCCL_NET
                value: "Socket"
            
            resources:
              requests:
                nvidia.com/gpu: 1
                cpu: "8"
                memory: "48Gi"
              limits:
                nvidia.com/gpu: 1
                cpu: "16"
                memory: "64Gi"
            
            volumeMounts:
              - name: model-cache
                mountPath: /models
              - name: dshm
                mountPath: /dev/shm
        
        volumes:
          # Use hostPath for persistent model cache on head node
          # This survives pod restarts and doesn't require RWX PVC
          - name: model-cache
            hostPath:
              path: /var/lib/vllm-models
              type: DirectoryOrCreate
          # Reduced from 16Gi - 8Gi is sufficient for model weight transfer
          - name: dshm
            emptyDir:
              medium: Memory
              sizeLimit: "8Gi"
  
  # Worker node configuration
  workerGroupSpecs:
    - groupName: gpu-workers
      replicas: 1
      minReplicas: 1
      maxReplicas: 1
      
      rayStartParams:
        num-gpus: '1'
        # Use fabric network for Ray communication
        node-ip-address: '10.10.10.2'
      
      template:
        metadata:
          labels:
            app: vllm-ray-worker
            ray-cluster: vllm-cluster
            ray-node-type: worker
        spec:
          runtimeClassName: nvidia
          
          # Pin worker to spark-ba63
          nodeSelector:
            kubernetes.io/hostname: spark-ba63
          
          tolerations:
            - key: nvidia.com/gpu
              operator: Exists
              effect: NoSchedule
          
          # Use host network for fabric access
          hostNetwork: true
          dnsPolicy: ClusterFirstWithHostNet
          
          containers:
            - name: ray-worker
              image: avarok/vllm-dgx-spark:v11
              imagePullPolicy: IfNotPresent
              
              env:
                - name: HF_TOKEN
                  valueFrom:
                    secretKeyRef:
                      name: hf-token-secret
                      key: HF_TOKEN
                - name: HF_HOME
                  value: /models/.cache
                - name: TRANSFORMERS_CACHE
                  value: /models/.cache
                - name: HF_HUB_CACHE
                  value: /models/.cache/hub
                - name: VLLM_HOST_IP
                  value: "10.10.10.2"
                - name: RAY_ADDRESS
                  value: "10.10.10.1:6379"
                - name: VLLM_USE_CUDA_GRAPH
                  value: "0"
                # NCCL configuration for fabric network (10.10.10.x)
                # Use explicit interfaces for head node (enP7s7) and worker node (enp1s0f1np1)
                - name: NCCL_SOCKET_IFNAME
                  value: "enP7s7,enp1s0f1np1"
                - name: NCCL_IB_DISABLE
                  value: "1"
                - name: NCCL_DEBUG
                  value: "INFO"
                - name: NCCL_P2P_DISABLE
                  value: "1"
                - name: GLOO_SOCKET_IFNAME
                  value: "enP7s7,enp1s0f1np1"
                # Force NCCL to use TCP/socket communication
                - name: NCCL_NET
                  value: "Socket"
              
              resources:
                requests:
                  nvidia.com/gpu: 1
                  cpu: "8"
                  memory: "48Gi"
                limits:
                  nvidia.com/gpu: 1
                  cpu: "16"
                  memory: "64Gi"
              
              volumeMounts:
                - name: model-cache
                  mountPath: /models
                - name: dshm
                  mountPath: /dev/shm
          
          volumes:
            # Use hostPath for persistent model cache on worker node
            # Same path as head node - models cached locally on each node
            - name: model-cache
              hostPath:
                path: /var/lib/vllm-models
                type: DirectoryOrCreate
            # Reduced shared memory - Ray workers don't need as much
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: "8Gi"
---
# Service to expose vLLM API via fabric network
# Note: vLLM runs on port 8080 via hostNetwork, accessible at 10.10.10.1:8080
apiVersion: v1
kind: Service
metadata:
  name: vllm-distributed-service
  namespace: llm-inference
  labels:
    app.kubernetes.io/name: vllm-distributed
spec:
  selector:
    ray-node-type: head
    ray-cluster: vllm-cluster
  ports:
    - name: ray-dashboard
      port: 8265
      targetPort: 8265
  type: ClusterIP
